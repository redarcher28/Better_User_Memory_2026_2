# Better_User_Memory_2026_2
2026年寒假实训：更好的用户记忆

# 难度：困难

# 更懂你的用户记忆

**文档信息**：ai-agent-projects-2026spring.md | 2025-12-31

## 实验目的

将 Agentic RAG 的多轮迭代检索能力应用于用户对话历史，构建一个可检索的长期记忆系统。验证这种方法在用户记忆评估框架三个层次（基础回忆、多会话检索、主动服务）上的能力和局限性。

## 背景知识

**用户记忆评估框架的三个层次：**

1. **第一层次：基础回忆**
   - 要求 Agent 能够准确回忆单次会话中用户提供的具体信息
   - 示例：如"我的支票账户号码是多少?"这类简单的事实查询

2. **第二层次：多会话检索**
   - 要求 Agent 能够跨越多个不同时间的会话整合信息
   - 包括两个子挑战：
     - 整合分散信息（如用户在不同会话中分别谈论了两辆车，Agent 需要综合了解用户的所有车辆）
     - 处理事实冲突（如多个家庭成员在不同会话中先后修改同一指令，Agent 需要判断哪个才是最终有效的）

3. **第三层次：主动服务**
   - 要求 Agent 能够主动发现不同信息间的隐藏关联并提供预警建议
   - 示例：用户在几个月前的会话中提到护照即将过期，最近又预订了国际机票，Agent 应该主动关联这两个事实并提醒用户续签护照

**Advanced JSON Cards 记忆模式：**
- 这是一种结构化的用户记忆表示方法，将用户的核心事实以 JSON 格式存储
- 每个 Card 包含多个字段：
  - `content`（事实内容，如"护照将于2025年2月18日过期"）
  - `backstory`（信息来源和上下文）
  - `person`（相关人员）
  - `relationship`（人员关系）等元数据
- 这些 JSON Cards 通常作为常驻上下文固定在 Agent 的提示词中，使 Agent 始终掌握用户的核心信息概览

## 实验内容描述

**核心思想：**
- 将用户的完整对话历史视为一个知识库
- 在索引阶段，系统将对话历史按固定窗口（如每 20 轮对话）分块并索引
- 在应用阶段，Agent 通过 `search_user_memory` 工具主动检索这些"记忆"

**上下文感知检索的实现：**
- 为每个对话块生成包含时间、人物、意图等背景信息的前缀摘要
- 示例：孤立的"好的，就订这个吧"变成"[上下文：用户正在确认从上海到西雅图的 500 美元单程机票] 好的，就订这个吧"
- 这种上下文前缀解决了传统文档分块方法的根本缺陷——将紧密关联的上下文分离导致的语义信息损失

**上下文增强的优势：**
- 在处理事实冲突时展现决定性优势
- 示例测试用例：妻子、丈夫、妻子先后三次修改同一转账指令
- 上下文前缀（"妻子设立初始电汇"、"丈夫修改电汇"、"妻子在丈夫修改后再次修改"）为判断最终有效指令提供了关键线索

**双层记忆架构：**
- 实验进一步探索将 Advanced JSON Cards 与上下文感知 RAG 结合的双层架构
- Advanced JSON Cards 作为常驻上下文存储结构化核心事实（如"护照将于 2025 年 2 月过期"、"已预订1月15日飞往东京的机票"）
- 上下文感知 RAG 提供对非结构化对话细节的按需检索

**第三层次测试案例的工作流程：**
- 用户询问："为我一月的东京之行，还有什么要准备的吗？"
- Agent 的工作流程：
  1. 首先审视常驻上下文中的 JSON Cards，从中掌握"东京之行(1月15日)"和"护照信息(2月18日过期)"两个核心事实
  2. 通过对比发现机票日期与护照过期日期接近，识别出潜在风险
  3. 使用 RAG 检索相关对话细节进行确认，找到当初讨论机票和护照的原始片段作为"证据"
  4. 最终主动提醒用户："您的护照将在旅行后一个月过期，强烈建议立即加急办理续签"

---

## 期望验收结果

1. 上下文增强后，Agent 能够正确处理事实冲突场景，判断出最终有效的指令
2. 双层记忆架构成功运行：JSON Cards 提供核心事实概览，RAG 提供对话细节按需检索
3. 在第三层次测试中，Agent 能够主动发现不同信息间的隐藏关联并提供预警建议
4. 理解结构化知识管理与非结构化信息检索协同工作的价值